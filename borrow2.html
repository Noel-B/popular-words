<!DOCTYPE html>
<html xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
  <head>
    <title>Borrow-Concept</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>    
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs-3.3.7/dt-1.10.16/fh-3.1.3/r-2.2.0/datatables.min.js"></script>    
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.0/js/dataTables.responsive.min.js"></script>    
   <script type="text/javascript" src="https://cdn.jsdelivr.net/g/mark.js(jquery.mark.min.js)"></script>   
   <script type="text/javascript" src="https://cdn.datatables.net/plug-ins/1.10.13/features/mark.js/datatables.mark.js"></script>
   <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>  
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
   <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>   
   <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
   <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs-3.3.7/dt-1.10.16/fh-3.1.3/r-2.2.0/datatables.min.css"/>   
   <link rel="stylesheet" type="https://cdn.jsdelivr.net/datatables.mark.js/2.0.0/datatables.mark.min.css"/>   
   <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">   
</head>
  <body>

<!-- the loader -->
    <div id="loader-wrapper" class="hide" style="height:100%;width:100%;background:#205284;position:fixed;z-index:99998;">
        <div id="loader-text" style="position: absolute;left: 50%;top: 50%;transform: translate(-50%, -50%);color:white;z-index:99999;font-size:28px;font-family: 'Roboto', sans-serif !important;">Hola! Just setting up the backend to optimize search.  This takes about a minute or two :)</div>
    </div>
    <div id="info-box" class="info-init-state hide">
        <button id="info-box-close"></button>
        <div id="instructions">
            <h2>About this Tool</h2>
            <h4>
            <ul>
                <li>This tool is designed to search through the Course NAME, ABSTRACT, DESCRIPTION and TARGET AUDIENCE metadata of active courses within SOU;</li>
                <li>It can accept any combination (and any number) of keywords and/or exact phrases;</li>
                <ul>
                    <li>Entering multiple values means that the tool will look for courses that have all of the keywords/phrases specified;</li>
                    <li>To do an “OR” search, then please perform a separate search for each keyword/phrase of interest;</li>
                    <li>Exact phrases must be enclosed in quotation marks. Sample: “Trinidad & Tobago FLBM staff”</li>
                </ul>
                <li>Use spaces to separate keywords/phrases. Do not use other characters like commas or semicolons to separate keywords/phrases (use them only if they’re a part of the actual keyword or phrase);</li>
                <ul>
                    <li>Sample (note that a space separates the keyword and phrase): Wells “Units, PAUAs and Pooling”</li>
                </ul>
                <li>You can also download results into Excel;</li>
                <li>If you are experiencing sluggish performance, then it is recommend that you use the Google Chrome browser, if available;</li>
                <li>This tool is more of a PROOF OF CONCEPT of how search can be done for current course metadata. Feedback is appreciated if you think there are missing critical feature(s).</li>
            </ul>
            </h4>
        </div>
    </div> 
<!-- the loader -->

    <div id="top-header" class="hide">
        <div id="search-div">
            <span class="text">enter keyword(s) and/or exact phrase(s) here</span>
            <input id="search-box" placeholder="enter keyword(s) and/or exact phrase(s) here">     
        </div>
        <button id="search-btn">Search</button>
        <button id="info">?</button>
        <span id="total"></span>    
    </div> 
    <div id="table-div" class="hide">
        <table id="noel-table" class="table table-striped table-bordered responsive" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th>word</th>
                    <th>occurrence</th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th></th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>    
<script src="js/xlsx.core.min.js"></script>
<script src="js/alasql.js"></script>
<script>
alasql.fn.DD = function(thisVal) { 
    if(thisVal > 0) {
    return ExcelDateToJSDate(thisVal).toDateString();
    } else {
        return "no date specified"
    }
}

alasql('CREATE TABLE noelbexcel');

//initialize fulldata
var fullData;

$('#loader-wrapper, #info-box, #table-div, #top-header').removeClass('hide');

    alasql.promise('SELECT * INTO noelbexcel FROM xlsx("test-db.xlsx")').then(function(data){
        $('#loader-wrapper').addClass('hide');
    }).then(function(data){

        //select everything --can we concatenate?
        return alasql.promise('SELECT * FROM noelbexcel');


        alasql.promise('SELECT VALUE COUNT(*) FROM noelbexcel').then(function(res1){
            $('#total').text('Total courses loaded: '+res1.toLocaleString());
            }).catch(function(err){
                console.log('Error:',err);
        });           
            

        }).catch(function(err){
        console.log('Error:',err);
    }).then(function(data){
            return fullText = data.map(function(elem){
                return elem.abstract;
                }).join(",");

        }).then(function(fullText){
            return first_pass = fullText.replace(/[\W_]+/g," ");
        
        }).then(function(first_pass){
            return count_words = count(first_pass);
            
        }).then(function(count_words){
            return output = Object.entries(count_words).map(([word, occurrence]) => ({word,occurrence}));
        }).then(function(output){
            
           // window.fullData = output;
            alasql.tables.fullWords.data = output; 
        }).then(function(output){


             return fullData = alasql("SELECT * FROM fullWords WHERE occurrence > 50 and word NOT IN ('and','a','the','or') ORDER BY occurrence DESC");
        }).then(function(fullData){

             $('#noel-table').DataTable({
                    "aaData": fullData,
                    "aoColumns": [
                        { "mData": "word" },
                        { "mData": "occurrence" },
                    ],
                    mark: true,
                    fixedHeader: true,
                    responsive: true,
                    "initComplete": function( settings, json ) {
                                    $('#loader-wrapper').addClass('hide');
                                    var tag2 = tag.toString().replace(/'/g, '');
                                    var fintag = tag2.replace(/,/g , " ");
                                    $('input[aria-controls="noel-table"]').val(fintag).trigger('keyup');
                                    //console.log(fintag);
                                    //console.log(tag);
                                    //console.log(xlsxdata);
                                    $('input[aria-controls="noel-table"]').val('');
                    },
                    "sDom": '<"top"iflpB<"clear">>rt<"bottom"iflpB<"clear">>',
                    "oLanguage": {
                                    "sSearch": "Quick Search:"
                                    },
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: 'Export to Excel',
                            title: 'Data Export'
                            }
                    ]
            });

        });


        /*
            return alasql.tables.fullWords.data = output;            
        }).then(function(output){
            window.fullData = alasql("SELECT * FROM fullWords WHERE occurrence > 50 and word NOT IN ('the','or') ORDER BY occurrence DESC");
        });

        */
alasql('CREATE TABLE fullWords');

var common_words = ["and","of"];
   

function count(sentence) {
  var list = sentence.toString().split(/,| /);
  var words = {};
  for (var i = 0; i < list.length; i++) {
    if (!(words.hasOwnProperty(list[i]))) {
      words[list[i]] = 0;
    }
    ++words[list[i]];
  }
  return words;
}

function search(sql, tag){
    $('#mytable').remove();
    var s = '';
    alasql.promise(sql)
            .then(function(xlsxdata){
              
            $('#noel-table').DataTable({
                    "aaData": xlsxdata,
                    "aoColumns": [
                        { "mData": "tax1" },
                        { "mData": "tax2" },
                        { "mData": "course_name" },
                        { "mData": "abstract" },
                        { "mData": "description" },
                        { "mData": "target_audience" },
                        { "mData": "available_from"},
                        { "mData": "discontinued_from" }
                    ],
                    mark: true,
                    fixedHeader: true,
                    responsive: true,
                    "initComplete": function( settings, json ) {
                                    $('#loader-wrapper').addClass('hide');
                                    var tag2 = tag.toString().replace(/'/g, '');
                                    var fintag = tag2.replace(/,/g , " ");
                                    $('input[aria-controls="noel-table"]').val(fintag).trigger('keyup');
                                    //console.log(fintag);
                                    //console.log(tag);
                                    //console.log(xlsxdata);
                                    $('input[aria-controls="noel-table"]').val('');
                    },
                    "sDom": '<"top"iflpB<"clear">>rt<"bottom"iflpB<"clear">>',
                    "oLanguage": {
                                    "sSearch": "Quick Search:"
                                    },
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: 'Export to Excel',
                            title: 'Data Export'
                            }
                    ]
            });

        }).catch(function(err){
                 console.log('Error:', err);
            });
}


function tagQuery(tag) {
    var str = '';
    for (var i = 0; i < tag.length; i++) {
        str += " AND concat(course_name, abstract, description, target_audience) like '%" + tag[i] + "%'\n"
    }
    return str;
}

function returnArr(text) {
    var str = text;
    var tokens = [].concat.apply([], str.split('"').map(function(v,i){
       return i%2 ? v : v.split(' ')
    })).filter(Boolean);
return tokens;
}


$('#search-btn').on('click', function(){

   

   var preText1 = $('#search-box').val();
   var preText2 = preText1.replace(/'/g, "");
   console.log(preText2);
   var finText = returnArr(preText2);
   var tag = finText;
   
   if (((!preText2.replace(/\s/g, '').length) || (preText2.replace(/\s/g, '').length < 2)) || preText1 === 'and' || preText1 === 'the') {
    alert("This tool is meant for a targeted search. Running your query will return most of the RDS courses! Please refine your search. Thank you");
} else {
    $('#noel-table').removeClass('info-init-state');
    $('#loader-wrapper').removeClass('hide');
    $('#loader-text').text("Running search. This should take only a couple of seconds, please wait..   If it's taking too long, please consider using Google Chrome as your browser.");
    $('#noel-table').DataTable().clear();
    $('#noel-table').DataTable().destroy();
   
   
   var sql = "SELECT COALESCE(tax1,'--') as tax1, COALESCE(tax2,'--') as tax2, course_name, COALESCE(abstract,'--') as abstract, COALESCE(description,'--') as description, COALESCE(target_audience,'--') as target_audience, COALESCE(DD(available_from),'--') as available_from, DD(discontinued_from) as discontinued_from FROM noelbexcel WHERE\n course_name is not null\n";
   sql += tagQuery(tag);
   console.log(sql);
   search(sql, tag);
}
});

function ExcelDateToJSDate(serial) {
        var utc_days = Math.floor(serial - 25569);
        var utc_value = utc_days * 86400;
        var date_info = new Date(utc_value * 1000);
        var fractional_day = serial - Math.floor(serial) + 0.0000001;
        var total_seconds = Math.floor(86400 * fractional_day);
        var seconds = total_seconds % 60;
        total_seconds -= seconds;
        var hours = Math.floor(total_seconds / (60 * 60));
        var minutes = Math.floor(total_seconds / 60) % 60;

        return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
    }

$('#search-box').on('input', function () { $('.text').text($('#search-box').val()); });

$( '#search-box' ).on('keypress', function(e){
   if ( e.keyCode == 13 ) {
     $('#search-btn').click();
   }
 });

$('#info, #info-box-close').on('click',function(){
    $('#info-box').toggleClass('info-init-state');
});

</script>

<style>

#search-box,
    .text {
       margin: 0;
      padding: 2px 10px;
      font-size: 24px;
      line-height: 32px;
      border: 1px solid #ccc;
      box-radius: 3px;
      height: 36px;
      font: 20px/20px sans-serif;
      transition: all 0.3s ease;
      border:none;
    }

    .text {
       padding-right: 15px;
      display: inline-block;
      visibility: hidden;
      white-space: pre;
    }
    
    #search-box {
     position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
    }
    
    #search-box::-ms-clear {
    display: none;
    }
    
    #search-div {
        background:red;
         display: inline-block;
      position: relative;
      box-sizing: border-box;
      padding-right:10px;
      transition: all 0.3s ease; 
    }
    #top-header {
        background:#F3AC07;
        padding:20px;
    }
    #search-btn {
        height:36px;
        background:#D70606;
        color:white;
        border:none;
        float:left;
        font-family: 'Roboto', sans-serif !important;
        font-size:18px;
        padding-left:25px;
        padding-right:25px;
        transition: all 0.3s ease;
        
    }
    #search-btn:hover {
        background:red;
    }
    #total {
        float:right;
        background: transparent;
        color:#fff3d9;
        font-family: 'Roboto', sans-serif !important;
        font-weight:bold;
        font-size:18px;
    }
::selection {
  background: #F3AC07; /* WebKit/Blink Browsers */
}
::-moz-selection {
  background: #F3AC07; /* Gecko Browsers */
}
*:focus {
    outline: none;
}


    #div1,
    #table-div {
        padding:20px;
        border-collapse:collapse;
    }
    
    #table-div {
    -webkit-transform: translateZ(0);
   -moz-transform: translateZ(0);
   -ms-transform: translateZ(0);
   -o-transform: translateZ(0);
   transform: translateZ(0);
    }

    
    #noel-table td:nth-child(3) {
        font-weight: bold !important;
    }
    
    #noel-table td:nth-child(4) {
        min-width: 250px !important;

    }
    #noel-table td:nth-child(5) {
        min-width: 150px !important;
    }
    #noel-table td:nth-child(4) {
        min-width: 150px !important; 
     }
   
   th {
       background: #337AB7 !important;
       color: white !important;
       border-color: #337AB7 !important;
   }
   tr {
       transition: all 0.3s ease; 
   }
   tbody tr:hover {
       background:#B9D5EC !important;
       color:black;
   }
    tbody tr:hover > td {
    border-left-color:#B9D5EC !important;
    border-right-color:#B9D5EC !important;
    }

    ul.dtr-details > li {
        border-bottom-color: transparent !important;
    }

    
   th::after {
       color:white !important;
   }
   
   div.dataTables_info,
   .dataTables_length {
       float:left !important;
       padding-left:10px !important;
       padding-right:10px !important;
   }
   
   div.dataTables_filter {
       display:none !important;
   }
   
 div.dataTables_paginate {
       float:right !important;
   }
  .dataTables_info {
       padding-top:4px !important;
       padding-bottom:4px !important;
       padding-right:10px !important;
       background: lightgrey;
   }
   mark {
       background: #f3cb07 !important;
   }
   
/* THE LOADER */
@-webkit-keyframes enter {
  0% {
    opacity: 0;
    top: -10px;
  }
  5% {
    opacity: 1;
    top: 0px;
  }
  50.9% {
    opacity: 1;
    top: 0px;
  }
  55.9% {
    opacity: 0;
    top: 10px;
  }
}
@keyframes enter {
  0% {
    opacity: 0;
    top: -10px;
  }
  5% {
    opacity: 1;
    top: 0px;
  }
  50.9% {
    opacity: 1;
    top: 0px;
  }
  55.9% {
    opacity: 0;
    top: 10px;
  }
}
@-moz-keyframes enter {
  0% {
    opacity: 0;
    top: -10px;
  }
  5% {
    opacity: 1;
    top: 0px;
  }
  50.9% {
    opacity: 1;
    top: 0px;
  }
  55.9% {
    opacity: 0;
    top: 10px;
  }
}




.clear {
  clear: both;
}

.last {
  margin-right: 0;
}

/* show & hide */
.hide {
    display:none !important;
}

td {
    font-family: 'Roboto', sans-serif !important;
    font-size:13px !important;
}
th {
    font-family: 'Lato', sans-serif !important;
}

#info-box {
    transition: all 0.3s ease;
    height:100%;
    width:100%;
    background:#383E42;
    padding:20px;
    -webkit-transform: translateZ(0);
   -moz-transform: translateZ(0);
   -ms-transform: translateZ(0);
   -o-transform: translateZ(0);
   transform: translateZ(0);
   z-index:99998;
   opacity:1;
   position:fixed;
   color:white;
   overflow-y:scroll;
}

#info-box *  li {
    margin-top:15px;
    line-height:1.5;
} 


.info-init-state {
    z-index:-1 !important;
    opacity:0 !important;
} 

#info, #info-box-close {
    color: white;
    font-size: 17px;
    border: 2px solid white;
    float: right;
    padding: 2.5px 8px;
    margin-left: 10px;
    font-weight: bold;
    background: none;
    transition: all 0.3s ease;
}
#info:hover {
    background:white;
    color:#EBA607;
}

#info-box-close {
  height: 50px;
  width: 50px;
  position: relative;
  box-sizing: border-box;
  line-height: 50px;
  display: inline-block;
  border:none;
  float:left;
  margin-top:12px;
}

#instructions {
    float:left;
    padding-left:15px;
    width:90%;
}

#instructions h2 {
    color:#EBA607;
}

#info-box-close:before, #info-box-close:after {
  transform: rotate(-45deg);
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  margin-top: -5px;
  margin-left: -25px;
  display: block;
  height: 8px;
  width: 35px;
  background-color: #fff;
  transition: all 0.25s ease-out;
  background:#EBA607;
}
#info-box-close:after {
  transform: rotate(-135deg);
}
#info-box-close:hover:before, #info-box-close:hover:after {
  transform: rotate(0deg);
  background:red;
}



.dt-button.buttons-excel {
background-color: #337ab7;
    border-color: #337ab7;
    color:white;
    padding:5px 15px;
    border:none;
    transition: all 0.3s ease;

}
.dt-button.buttons-excel:hover {
background: #217346;
}
</style>

  </body>
</html>
